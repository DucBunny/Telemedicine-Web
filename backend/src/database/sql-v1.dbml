// ======================
// ENUM DEFINITIONS
// ======================

Enum user_role {
  admin        // Quản trị hệ thống
  doctor       // Bác sĩ
  patient      // Bệnh nhân
}

Enum user_status {
  active       // Tài khoản đang hoạt động
  locked       // Tài khoản bị khóa
}

Enum gender_type {
  male         // Nam
  female       // Nữ
  other        // Khác
}

Enum device_status {
  active       // Thiết bị đang hoạt động
  inactive     // Thiết bị ngừng sử dụng
  maintenance  // Thiết bị đang bảo trì
}

Enum alert_severity {
  low          // Mức độ cảnh báo thấp
  medium       // Mức độ cảnh báo trung bình
  critical     // Cảnh báo nghiêm trọng
}

Enum appointment_status {
  pending      // Chờ bác sĩ xác nhận lịch hẹn
  confirmed    // Lịch hẹn đã được xác nhận
  completed    // Buổi khám đã hoàn thành
  cancelled    // Lịch hẹn bị hủy
}

Enum call_status {
  missed       // Cuộc gọi nhỡ
  rejected     // Cuộc gọi bị từ chối
  completed    // Cuộc gọi thành công
}

Enum health_status {
  normal       // Tình trạng sức khỏe bình thường
  warning      // Có dấu hiệu bất thường
  critical     // Nguy hiểm, cần can thiệp y tế
}

// ======================
// USERS & AUTH
// ======================

Table users {
  id int [pk, increment]
  full_name varchar [not null]                // Họ và tên
  email varchar [unique, not null]            // Email đăng nhập
  password varchar [not null]                 // Mật khẩu
  role user_role [default: 'patient']         // Phân quyền
  avatar varchar                              // Ảnh đại diện
  phone_number varchar                        // Số điện thoại

  status user_status [default: 'active']      // Trạng thái tài khoản
  last_login_at datetime                      // Thời điểm đăng nhập gần nhất

  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
}

Table refresh_tokens {
  id int [pk, increment]
  token varchar [not null]
  user_id int [not null, ref: > users.id]     // User sở hữu token
  expires_at datetime [not null]              // Thời điểm hết hạn
  is_revoked boolean [default: false]         // Token đã bị thu hồi hay chưa
  device_info varchar                         // Thông tin thiết bị đăng nhập

  created_at timestamp [default: `now()`]
  updated_at timestamp [default: `now()`]
}

// ======================
// MEDICAL ROLES
// ======================

Table doctors {
  user_id int [pk, ref: - users.id]

  specialization varchar                      // Chuyên khoa
  degree varchar                              // Bằng cấp
  experience_years int                        // Số năm kinh nghiệm
  bio text                                    // Giới thiệu ngắn về bác sĩ

  created_at timestamp [default: `now()`]     
  updated_at timestamp [default: `now()`]      
}

Table patients {
  user_id int [pk, ref: - users.id]      

  date_of_birth date                      // Ngày sinh
  gender gender_type                      // Giới tính
  blood_type varchar                      // Nhóm máu
  height float [note: 'cm']               // Chiều cao (cm)
  weight float [note: 'kg']               // Cân nặng (kg)
  medical_history text                    // Tiền sử bệnh
  address varchar                         // Địa chỉ

  created_at timestamp [default: `now()`] 
  updated_at timestamp [default: `now()`] 
}

Table patient_doctors {
  patient_id int [ref: > patients.user_id]  
  doctor_id int [ref: > doctors.user_id]   

  role varchar                              // Vai trò: bác sĩ chính / tư vấn
  assigned_at datetime                      // Thời điểm phân công

  primary key (patient_id, doctor_id)       // Quan hệ nhiều-nhiều
}

// ======================
// DEVICES & IOT
// ======================

Table devices {
  device_id varchar [pk]                            // MAC Address của thiết bị ESP32
  name varchar                                      // Tên thiết bị
  status device_status [default: 'active']          // Trạng thái thiết bị

  assigned_to int [ref: > patients.user_id, null]   // Thiết bị gắn với bệnh nhân nào

  created_at timestamp [default: `now()`]   
  updated_at timestamp [default: `now()`]   
}

// ======================
// ALERTS & AI
// ======================

Table alerts {
  id int [pk, increment]                    

  patient_id int [not null, ref: > patients.user_id]        // Bệnh nhân liên quan
  prediction_id int [ref: > health_predictions.id, null]    // Kết quả AI sinh cảnh báo

  type varchar                                  // Loại chỉ số (nhịp tim, SpO2,…)
  value varchar                                 // Giá trị đo được
  message varchar                               // Nội dung cảnh báo
  severity alert_severity [default: 'medium']   // Mức độ nghiêm trọng

  source varchar                           // Nguồn cảnh báo: threshold | ml | manual
  is_resolved boolean [default: false]     // Đã xử lý hay chưa

  acknowledged_by int [ref: > doctors.user_id, null]    // Bác sĩ xác nhận
  acknowledged_at datetime                              // Thời điểm xác nhận

  created_at timestamp [default: `now()`]  
  updated_at timestamp [default: `now()`]  
}

Table health_predictions {
  id int [pk, increment]                  

  patient_id int [ref: > patients.user_id]  // Bệnh nhân được dự đoán

  predicted_status health_status            // Trạng thái sức khỏe dự đoán
  confidence float                          // Độ tin cậy (0–1)

  model_version varchar                     // Phiên bản mô hình ML
  input_window int                          // Số mẫu đầu vào (window size)

  created_at datetime [default: `now()`]    
}

// ======================
// MEDICAL DATA
// ======================


Table medical_records {                     // Hồ sơ khám bệnh 
  id int [pk, increment]                 

  patient_id int [ref: > patients.user_id]  // Bệnh nhân
  doctor_id int [ref: > doctors.user_id]    // Bác sĩ khám

  diagnosis text                            // Chẩn đoán
  prescription text                         // Đơn thuốc
  notes text                                // Ghi chú thêm
  visit_date datetime [default: `now()`]    // Ngày khám

  created_at timestamp [default: `now()`] 
  updated_at timestamp [default: `now()`] 
}

Table medical_attachments {             // File đính kèm
  id int [pk, increment]                  

  medical_record_id int [ref: > medical_records.id]   // Hồ sơ liên quan

  file_url varchar                      // Đường dẫn file
  file_type varchar                     // Loại file: image | pdf
  uploaded_at datetime                  // Thời điểm upload
}

// ======================
// TELEMEDICINE
// ======================

Table appointments {                        // Lịch hẹn
  id int [pk, increment]                  

  patient_id int [ref: > patients.user_id]  // Bệnh nhân
  doctor_id int [ref: > doctors.user_id]    // Bác sĩ

  scheduled_at datetime [not null]          // Thời gian hẹn
  ended_at datetime                         // Thời gian kết thúc

  status appointment_status [default: 'pending']  // Trạng thái lịch hẹn
  meeting_link varchar                   // Link khám online
  reason text                            // Lý do khám
  cancel_reason text                     // Lý do hủy

  created_at timestamp [default: `now()`] 
  updated_at timestamp [default: `now()`] 
}

Table chat_messages {
  id int [pk, increment]                 

  sender_id int [ref: > users.id]         // Người gửi
  receiver_id int [ref: > users.id]       // Người nhận

  message text                            // Nội dung tin nhắn
  attachment_url varchar                  // File/ảnh đính kèm
  is_read boolean [default: false]        // Đã đọc hay chưa

  created_at timestamp [default: `now()`] 
  updated_at timestamp [default: `now()`] 
}

Table call_logs {
  id int [pk, increment]                   

  caller_id int [ref: > users.id]           // Người gọi
  receiver_id int [ref: > users.id]         // Người nhận

  start_time datetime                       // Thời điểm bắt đầu
  end_time datetime                         // Thời điểm kết thúc
  duration_seconds int                      // Thời lượng cuộc gọi (giây)

  status call_status [default: 'missed']    // Trạng thái cuộc gọi

  created_at timestamp [default: `now()`] 
  updated_at timestamp [default: `now()`]
}